<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiftMint Web App</title>
    <link rel="stylesheet" href="./CSS5/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- –ë–ê–ù–ù–ï–†–´ -->
        <div id="reg-success-banner" class="top-banner success">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! ‚úÖ</div>
        <div id="user-linked-banner" class="top-banner info">–Æ–∑–µ—Ä–Ω–µ–π–º –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–∏—Å—Ç–µ–º–µ üîó</div>
        <div id="condition-banner" class="top-banner warning">–í—ã–ø–æ–ª–Ω–∏—Ç–µ —É—Å–ª–æ–≤–∏—è: –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏! üéÅ</div>

        <header class="header">
            <h1 class="title">GiftMint</h1>
            <div class="conditions-box">
                <p class="conditions-label">üéÅ –•–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å NFT-–ø–æ–¥–∞—Ä–æ–∫?</p>
                <p class="conditions-text">1) –ù–∞–∂–º–∏ ¬´–ö—Ä—É—Ç–∏—Ç—å¬ª –∏ –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–∑—å—è–º<br>2) –ß–µ–º —á–∞—â–µ –¥–µ–ª–∏—à—å—Å—è ‚Äî —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å üíé</p>
            </div>
        </header>

        <!-- –†–£–õ–ï–¢–ö–ò (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –î–ò–ó–ê–ô–ù–ï) -->
        <div class="roulette-section">
            <div class="roulette-wrapper"><div class="roulette-track" id="track1">
                <div class="nft-card">üèÜ <span>‚≠ê 100</span></div><div class="nft-card">üíé <span>‚≠ê 100</span></div>
                <div class="nft-card">üçæ <span>‚≠ê 50</span></div><div class="nft-card">üèÜ <span>‚≠ê 100</span></div>
                <div class="nft-card">üíé <span>‚≠ê 100</span></div><div class="nft-card">üçæ <span>‚≠ê 50</span></div>
            </div></div>
            <button class="spin-btn action-spin" data-goal="5">–ö—Ä—É—Ç–∏—Ç—å <span class="share-count">0</span>/5</button>
        </div>

        <div class="roulette-section">
            <div class="roulette-wrapper"><div class="roulette-track" id="track2">
                <div class="nft-card pink"><img src="./images/img1.png" class="nft-image"><span>‚≠ê 623</span></div>
                <div class="nft-card pink"><img src="./images/img2.png" class="nft-image"><span>‚≠ê 1022</span></div>
                <div class="nft-card pink"><img src="./images/img3.png" class="nft-image"><span>‚≠ê 4460</span></div>
                <div class="nft-card pink"><img src="./images/img1.png" class="nft-image"><span>‚≠ê 623</span></div>
                <div class="nft-card pink"><img src="./images/img2.png" class="nft-image"><span>‚≠ê 1022</span></div>
            </div></div>
            <button class="spin-btn action-spin" data-goal="10">–ö—Ä—É—Ç–∏—Ç—å <span class="share-count">0</span>/10</button>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
        <footer class="footer" id="registration-section">
            <label for="username">–í–≤–µ–¥–∏ username –∞–∫–∫–∞—É–Ω—Ç–∞ –∫—É–¥–∞ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</label>
            <div class="input-with-btn">
                <input type="text" id="username" placeholder="@username...">
                <button id="next-to-wallet" class="next-btn">‚ûî</button>
            </div>
            <span id="username-error" class="error-text">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —é–∑–µ—Ä–Ω–µ–π–º</span>
        </footer>

        <div id="wallet-section" class="wallet-box">
            <p style="margin-bottom: 15px; font-weight: bold;">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏:</p>
            <div id="ton-connect-btn"></div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê -->
    <div id="modal-reg-required" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">–í–Ω–∏–º–∞–Ω–∏–µ!</h2>
            <p class="modal-subtitle">–î–ª—è –Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</p>
            <button id="go-to-reg" class="modal-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
    </div>

    <script>
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://balbesss213.github.io/my-tg-app/tonconnect-manifest.json', 
            buttonRootId: 'ton-connect-btn' 
        });

        const db = {
            get isReg() { return localStorage.getItem('isReg') === 'true' },
            set isReg(v) { localStorage.setItem('isReg', v) },
            get count() { return parseInt(localStorage.getItem('count') || '0') },
            set count(v) { localStorage.setItem('count', v) }
        };

        const usernameInput = document.getElementById('username');
        const usernameError = document.getElementById('username-error');
        
        // --- –õ–û–ì–ò–ö–ê –®–ê–†–ò–ù–ì–ê (–° –ó–ê–©–ò–¢–û–ô –û–¢ –ë–´–°–¢–†–û–ì–û –ó–ê–ö–†–´–¢–ò–Ø) ---
        let shareTimestamp = 0;
        document.querySelectorAll('.action-spin').forEach(btn => {
            btn.onclick = () => {
                if (!db.isReg) {
                    document.getElementById('modal-reg-required').style.display = 'flex';
                } else {
                    showBanner('condition-banner');
                    shareTimestamp = Date.now(); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞–∂–∞—Ç–∏—è
                    Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=https://t.me/NFTreat_Bot/myapp&text=–ó–∞–±–∏—Ä–∞–π —Å–≤–æ–π NFT –ø–æ–¥–∞—Ä–æ–∫! üéÅ`);
                }
            };
        });

        // "–°–∫–∞–Ω–µ—Ä" –≤–æ–∑–≤—Ä–∞—Ç–∞: –µ—Å–ª–∏ —é–∑–µ—Ä –≤–µ—Ä–Ω—É–ª—Å—è –≤ –∞–ø–ø–∫—É
        window.onfocus = () => {
            if (shareTimestamp > 0) {
                const timeDiff = Date.now() - shareTimestamp;
                if (timeDiff > 4000) { // –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª –±–æ–ª—å—à–µ 4 —Å–µ–∫—É–Ω–¥ ‚Äî –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º
                    db.count += 1;
                    updateUI();
                }
                shareTimestamp = 0;
            }
        };

        // --- –õ–û–ì–ò–ö–ê –ö–ù–û–ü–ö–ò NEXT (–°–¢–†–ï–õ–û–ß–ö–ê) ---
        document.getElementById('next-to-wallet').onclick = async () => {
            let val = usernameInput.value;
            if (val.length > 3 && !/[–∞-—è—ë]/i.test(val)) {
                // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä
                showBanner('user-linked-banner');
                // 2. –°–∫—Ä–æ–ª–ª–∏–º –∫ –∫–æ—à–µ–ª—å–∫—É
                document.getElementById('wallet-section').scrollIntoView({ behavior: 'smooth' });
                // 3. –°–†–ê–ó–£ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–æ—à–µ–ª—å–∫–∞ (–∞–≤—Ç–æ-—Ç–µ–ø)
                setTimeout(async () => {
                    await tonConnectUI.openModal();
                }, 1000);
            } else {
                usernameError.style.display = 'block';
            }
        };

        // –ú–æ–¥–∞–ª–∫–∞ -> —Å–∫—Ä–æ–ª–ª
        document.getElementById('go-to-reg').onclick = () => {
            document.getElementById('modal-reg-required').style.display = 'none';
            document.getElementById('registration-section').scrollIntoView({ behavior: 'smooth' });
        };

        tonConnectUI.onStatusChange(wallet => {
            if (wallet && !db.isReg) {
                db.isReg = true;
                showBanner('reg-success-banner');
                setTimeout(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 2000);
            }
            updateUI();
        });

        function showBanner(id) {
            const b = document.getElementById(id);
            b.classList.add('show');
            setTimeout(() => b.classList.remove('show'), 3500);
        }

        function updateUI() {
            document.querySelectorAll('.share-count').forEach(el => el.innerText = db.count);
        }

        usernameInput.addEventListener('input', () => {
            if (!usernameInput.value.startsWith('@')) usernameInput.value = '@' + usernameInput.value.replace('@','');
            usernameError.style.display = /[–∞-—è—ë]/i.test(usernameInput.value) ? 'block' : 'none';
        });

        updateUI();
    </script>
</body>
</html>